#!/usr/bin/env bash
set -euo pipefail

# ─── Colours ───────────────────────────────────────────────
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m'

# ─── Environment ──────────────────────────────────────────
TARGET_UID="${UID:-1001}"
TARGET_GID="${GID:-1001}"
TARGET_UNAME="${USERNAME:-mluser}"
HOME_DIR="/home/code"

if [ "$TARGET_UNAME" = "root" ]; then
    echo -e "${YELLOW}Running as root – skipping user setup.${NC}"
    exec "$@"
fi

setup_user() {
    echo "→ Setting up user '${TARGET_UNAME}' (UID:${TARGET_UID}, GID:${TARGET_GID}), home=${HOME_DIR}"

    # ─ group ─
    if getent group "${TARGET_UNAME}" >/dev/null; then
        current_gid=$(getent group "${TARGET_UNAME}" | cut -d: -f3)
        [[ "${current_gid}" != "${TARGET_GID}" ]] && groupmod -g "${TARGET_GID}" "${TARGET_UNAME}"
    elif getent group "${TARGET_GID}" >/dev/null; then
        old=$(getent group "${TARGET_GID}" | cut -d: -f1)
        groupmod -n "${TARGET_UNAME}" "${old}"
    else
        groupadd -g "${TARGET_GID}" "${TARGET_UNAME}"
    fi

    # ─ user ─
    if id -u "${TARGET_UNAME}" >/dev/null 2>&1; then
        current_uid=$(id -u "${TARGET_UNAME}")
        [[ "${current_uid}" != "${TARGET_UID}" ]] && usermod -u "${TARGET_UID}" "${TARGET_UNAME}"
        usermod -g "${TARGET_GID}" "${TARGET_UNAME}"
        usermod -d "${HOME_DIR}" -m "${TARGET_UNAME}"
    elif getent passwd "${TARGET_UID}" >/dev/null; then
        old=$(getent passwd "${TARGET_UID}" | cut -d: -f1)
        usermod -l "${TARGET_UNAME}" "${old}"
        usermod -d "${HOME_DIR}" -m "${TARGET_UNAME}"
        usermod -g "${TARGET_GID}" "${TARGET_UNAME}"
    else
        useradd -u "${TARGET_UID}" -g "${TARGET_GID}" -d "${HOME_DIR}" -m -s /bin/bash "${TARGET_UNAME}"
    fi

    # ─ chown home ─
    echo -e "${GREEN}→ Chown -R ${TARGET_UNAME}:${TARGET_UNAME} ${HOME_DIR}${NC}"
    mkdir -p "${HOME_DIR}"
    chown -R "${TARGET_UID}:${TARGET_GID}" "${HOME_DIR}"
}

if [ "$(id -u)" -eq 0 ]; then
    setup_user
    echo "→ Switching to '${TARGET_UNAME}' and exec: $*"
    exec gosu "${TARGET_UNAME}" code-server --bind-addr 0.0.0.0:8080 .
else
    echo -e "${YELLOW}Not running as root → executing: $*${NC}"
    exec "$@"
fi
